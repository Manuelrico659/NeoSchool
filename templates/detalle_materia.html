<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Materia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/interfaces.css') }}">
    <script>
        // Se ejecuta cuando la página se carga
        document.addEventListener("DOMContentLoaded", function() {
            // Inicializar todos los checkboxes con palomita (asistencia marcada)
            inicializarAsistencia();
        });

        function inicializarAsistencia() {
            // Marcar todos los checkboxes de los días futuros
            const today = new Date();
            const checkboxes = document.querySelectorAll('.asistencia-checkbox input');
            
            checkboxes.forEach(checkbox => {
                const fechaCheckbox = new Date(checkbox.dataset.fecha);
                // Si el checkbox es de un día futuro, lo dejamos marcado
                if (fechaCheckbox >= today) {
                    checkbox.checked = true;
                }
            });
        }

        function actualizarAsistencia(estudianteId, fecha, checkbox) {
            console.log(estudianteId, fecha, checkbox); // Depuración en consola

            // Actualizamos el estado de la asistencia en el servidor
            fetch("{{ url_for('actualizar_asistencias') }}?id_materia={{ materia_id }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `asistencia_${estudianteId}_${fecha}=${checkbox.checked ? '1' : '0'}`
            }).then(response => response.json())
            .then(data => {
                if (checkbox.checked) {
                    // Si el checkbox está marcado (asistencia), no incrementamos faltas
                    actualizarFaltas(estudianteId, false);
                } else {
                    // Si no está marcado (falta), incrementamos faltas
                    actualizarFaltas(estudianteId, true);
                }
            }).catch(error => {
                console.error("Error al actualizar asistencia", error);
            });
        }

        // Incrementa o decrementa el contador de faltas dependiendo de si hubo asistencia o no
        function actualizarFaltas(estudianteId, esFalta) {
            let faltasSpan = document.getElementById(`faltas_${estudianteId}`);
            let faltasActuales = parseInt(faltasSpan.innerText);

            // Si es falta, incrementamos el contador
            if (esFalta) {
                faltasSpan.innerText = faltasActuales + 1;
            } else {
                // Si es asistencia, decrementamos el contador (si hay faltas para quitar)
                if (faltasActuales > 0) {
                    faltasSpan.innerText = faltasActuales - 1;
                }
            }
        }

    </script>
</head>
<body>
    <div class="sidebar">
        <h2>Gestión de Materias</h2>
        <ul>
            <li><a href="#">Inicio</a></li>
            <li><a href="#">Materias</a></li>
            <li><a href="#">Estudiantes</a></li>
            <li><a href="#">Notas</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="content-section">
            <h1>Detalles de la Materia</h1>

            <h2>Asistencias</h2>

            <div class="asistencias-container">
                {% for estudiante in estudiantes %}
                <div class="estudiante-card">
                    <span class="estudiante-nombre">{{ estudiante[1] }} {{ estudiante[2] }}</span>
                
                    <div class="asistencia-dias">
                        {% for fecha in fechas %}
                            <label class="asistencia-checkbox">
                                <input type="checkbox" 
                                    {% if asistencia_por_estudiante[estudiante[0]][fecha.strftime('%Y-%m-%d')] == 1 %}checked{% endif %}
                                    data-fecha="{{ fecha.strftime('%Y-%m-%d') }}"
                                    onchange="actualizarAsistencia({{ estudiante[0] }}, '{{ fecha.strftime('%Y-%m-%d') }}', this)">
                                {{ fecha.strftime('%d-%m-%Y') }}
                            </label>
                        {% endfor %}
                    </div>
                    
                
                    <span class="faltas">Faltas: <span id="    faltas_{{ estudiante[0] }}">{{ faltas[estudiante[0]] }}</span></span>
                </div>                
                {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>
