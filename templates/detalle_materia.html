<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Materia</title>
    <script>
        // Función para actualizar la asistencia
        function actualizarAsistencia(estudianteId, fecha, checkbox) {
            const estado = checkbox.checked ? true : false;

            // Enviar la actualización al servidor con AJAX
            fetch('/actualizar_asistencia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    estudiante_id: estudianteId,
                    fecha: fecha,
                    estado: estado,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualiza las faltas si la respuesta fue exitosa
                    const faltasElement = document.getElementById(`faltas-${estudianteId}`);
                    const nuevoValor = estado ? parseInt(faltasElement.textContent) - 1 : parseInt(faltasElement.textContent) + 1;
                    faltasElement.textContent = nuevoValor;

                    // Actualiza el estado visualmente
                    const estadoCell = document.getElementById(`estado-${estudianteId}-${fecha}`);
                    estadoCell.textContent = estado ? "Asistió" : "Falta";
                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Hubo un problema al actualizar la asistencia.');
            });
        }

        // Función para actualizar calificación
        function actualizarCalificacion(estudianteId, calificacionInput) {
            const calificacion = calificacionInput.value;

            // Enviar la actualización de calificación al servidor con AJAX
            fetch('/actualizar_calificacion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    estudiante_id: estudianteId,
                    calificacion: calificacion,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Calificación actualizada con éxito');
                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Hubo un problema al actualizar la calificación.');
            });
        }
    </script>
</head>
<body>
    <!-- Barra superior con botones de navegación -->
    <div class="nav-bar">
        <button onclick="window.location.href='/inicio'">Inicio</button>
        <button onclick="window.location.href='/asistencias/{{ materia_id }}'">Asistencias</button>
        <button onclick="window.location.href='/calificaciones/{{ materia_id }}'">Calificaciones</button>
        <button onclick="window.location.href='/detalle_materia/{{ materia_id }}'">Detalle Materia</button>
        <button onclick="window.location.href='/home'">Regresar</button> <!-- Botón de regresar -->
    </div>

    <h1>Detalle de Materia</h1>

    <table>
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Faltas</th>
                <th>Calificación</th>
                {% for fecha in fechas %}
                    <th>{{ fecha }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for estudiante in estudiantes %}
                <tr>
                    <td>{{ estudiante.nombre }} {{ estudiante.apellido_paterno }}</td>
                    <!-- Mostrar faltas -->
                    <td id="faltas-{{ estudiante.id_alumno }}">{{ faltas_por_estudiante[estudiante.id_alumno] }}</td>
                    <!-- Mostrar calificación -->
                    <td>
                        <input type="number" id="calificacion-{{ estudiante.id_alumno }}" value="{{ estudiante.calificacion }}" onchange="actualizarCalificacion({{ estudiante.id_alumno }}, this)" />
                    </td>
                    {% for fecha in fechas %}
                        <td>
                            <!-- Checkbox para asistencia -->
                            <input type="checkbox" 
                                   id="asistencia-{{ estudiante.id_alumno }}-{{ fecha }}" 
                                   {% if asistencia_por_estudiante[estudiante.id_alumno][fecha] %} checked {% endif %}
                                   onclick="actualizarAsistencia({{ estudiante.id_alumno }}, '{{ fecha }}', this)" />
                            <!-- Estado de asistencia -->
                            <span id="estado-{{ estudiante.id_alumno }}-{{ fecha }}">
                                {% if asistencia_por_estudiante[estudiante.id_alumno][fecha] %}
                                    Asistió
                                {% else %}
                                    Falta
                                {% endif %}
                            </span>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
